@model StudentInformationSystem.Models.ChangePasswordViewModel

@{
    ViewBag.Title = "修改密码";
}

<h2>修改密码</h2>
<hr />

@using (Html.BeginForm("ChangePassword", "Student", FormMethod.Post, new { @class = "form-horizontal", role = "form" }))
{
    @Html.AntiForgeryToken()

    @* 显示所有验证错误摘要 *@
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <div class="form-group">
        @Html.LabelFor(m => m.OldPassword, new { @class = "col-md-2 control-label" })
        <div class="col-md-10">
            @Html.PasswordFor(m => m.OldPassword, new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.OldPassword, "", new { @class = "text-danger" })
        </div>
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.NewPassword, new { @class = "col-md-2 control-label" })
        <div class="col-md-10">
            @Html.PasswordFor(m => m.NewPassword, new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.NewPassword, "", new { @class = "text-danger" })
        </div>
    </div>
    <div class="form-group">
        @Html.LabelFor(m => m.ConfirmPassword, new { @class = "col-md-2 control-label" })
        <div class="col-md-10">
            @Html.PasswordFor(m => m.ConfirmPassword, new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.ConfirmPassword, "", new { @class = "text-danger" })
        </div>
    </div>
    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <input type="submit" value="确认修改" class="btn btn-success" />
            @Html.ActionLink("返回控制台", "Index", null, new { @class = "btn btn-default" })
        </div>
    </div>

    @* 如果Controller传递了成功消息，就在这里显示 *@
    if (ViewBag.SuccessMessage != null)
    {
        <div class="alert alert-success col-md-offset-2 col-md-10">
            @ViewBag.SuccessMessage
        </div>
    }
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
<script>
    // 工具函数：Base64Url 与 ArrayBuffer 互转
    function base64UrlToBuffer(str) {
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        let pad = str.length % 4;
        if (pad !== 0) { str += new Array(5 - pad).join('='); }
        let binary = atob(str);
        let bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) { bytes[i] = binary.charCodeAt(i); }
        return bytes.buffer;
    }

    function bufferToBase64Url(buffer) {
        let bytes = new Uint8Array(buffer);
        let str = '';
        for (let charCode of bytes) { str += String.fromCharCode(charCode); }
        let base64 = btoa(str);
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // 1. 加载表格数据
    function loadPasskeys() {
        $.get('/Passkey/GetUserPasskeys', function (res) {
            if (res.status === 'ok') {
                let html = '';
                res.data.forEach(p => {
                    html += `<tr>
                                <td><strong>${p.Name}</strong></td>
                                <td>${p.RegDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePasskey(${p.Id})">删除</button>
                                </td>
                             </tr>`;
                });
                if (html === '') html = '<tr><td colspan="3" class="text-center text-muted">您还未绑定任何通行密钥。</td></tr>';
                $('#passkeyTableBody').html(html);
            }
        });
    }

    // 2. 删除通行密钥
    window.deletePasskey = function (id) {
        if (confirm('确定要删除这个通行密钥吗？删除后将无法使用该设备登录。')) {
            $.post('/Passkey/DeletePasskey', { id: id }, function (res) {
                if (res.status === 'ok') {
                    loadPasskeys(); // 重新加载表格
                } else {
                    alert(res.errorMessage);
                }
            });
        }
    }

    // 页面加载完毕后拉取数据
    $(document).ready(function () {
        loadPasskeys();
    });

    // 3. 绑定按钮点击事件（弹框命名）
    $('#btnRegisterPasskey').click(async function () {
        if (!window.PublicKeyCredential) {
            alert("您的浏览器或设备不支持通行密钥！");
            return;
        }

        // 【弹框问名字】
        let passkeyName = prompt("请为该通行密钥命名（例如：我的iPhone、办公电脑）：", "我的设备");
        if (!passkeyName) {
            return; // 用户点击了取消
        }

        try {
            let options = await $.post('/Passkey/MakeCredentialOptions');
            if (options.status === "error") {
                alert(options.errorMessage); return;
            }

            options.challenge = base64UrlToBuffer(options.challenge);
            options.user.id = base64UrlToBuffer(options.user.id);
            if (options.excludeCredentials) {
                for (let cred of options.excludeCredentials) cred.id = base64UrlToBuffer(cred.id);
            }

            let credential = await navigator.credentials.create({ publicKey: options });

            let attestationResponse = {
                id: credential.id,
                rawId: bufferToBase64Url(credential.rawId),
                type: credential.type,
                response: {
                    attestationObject: bufferToBase64Url(credential.response.attestationObject),
                    clientDataJSON: bufferToBase64Url(credential.response.clientDataJSON)
                }
            };

            // 【发给后端时带上名字】(URL 拼接了 ?name=)
            let verifyResp = await $.ajax({
                url: '/Passkey/MakeCredential?name=' + encodeURIComponent(passkeyName),
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(attestationResponse)
            });

            if (verifyResp.status === 'ok') {
                alert('🎉 通行密钥绑定成功！');
                loadPasskeys(); // 绑定成功后刷新表格
            } else {
                alert('绑定失败: ' + verifyResp.errorMessage);
            }
        } catch (err) {
            console.error(err);
            alert("注册已取消或发生错误。");
        }
    });</script>
}

<hr class="my-5" />

<div class="card mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h4 class="mb-0">通行密钥 (Passkey) 管理</h4>
        <button type="button" id="btnRegisterPasskey" class="btn btn-success btn-sm">
            <i class="bi bi-fingerprint"></i> 添加新设备
        </button>
    </div>
    <div class="card-body">
        <p class="text-muted small">添加通行密钥后，您可以使用此设备的指纹、面容或 PIN 码直接登录，无需输入密码。</p>
        <table class="table table-bordered table-hover">
            <thead class="table-light">
                <tr>
                    <th>设备名称</th>
                    <th>绑定时间</th>
                    <th style="width: 100px;">操作</th>
                </tr>
            </thead>
            <tbody id="passkeyTableBody">
                <tr><td colspan="3" class="text-center text-muted">正在加载...</td></tr>
            </tbody>
        </table>
    </div>
</div>