@model StudentInformationSystem.Models.CourseSelectionViewModel
@{
    ViewBag.Title = "在线选课";
}

<h2>在线选课与退选</h2>
<p class="text-muted">请根据培养计划要求，完成本学期的课程选择。</p>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>拦截提示：</strong> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>操作成功：</strong> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="timetable-tabs" style="margin-top: 15px;">
    <button class="btn btn-primary active" data-target="#my-selected">我的已选课程 <span class="badge bg-light text-dark">@Model.EnrolledCourses.Count</span></button>
    <button class="btn btn-light" data-target="#sports-market">体育选修区</button>
    <button class="btn btn-light" data-target="#other-market">其他选修区</button>
</div>
<hr />

<div class="tab-content" id="main-tab-content" style="padding-top: 10px;">

    <div class="tab-pane active" id="my-selected">
        <div class="alert alert-warning" style="padding: 10px; margin-bottom: 15px;">
            <i class="glyphicon glyphicon-info-sign"></i>
            <strong>注意：</strong> 带有 <span class="badge bg-danger">必修</span> 标记的课程为教务处统一排课，学生不可自行退选。
        </div>

        @if (Model.EnrolledCourses.Any())
        {
            var courseSchedules = ViewBag.CourseSchedules as List<StudentInformationSystem.Models.ClassSessions>;
            if (courseSchedules == null) { courseSchedules = new List<StudentInformationSystem.Models.ClassSessions>(); }

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>授课教师</th>
                            <th>学分</th>
                            <th>上课时间与地点</th>
                            <th class="text-center" style="width: 100px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.EnrolledCourses)
                        {
                            <tr>
                                <td>
                                    <strong>@item.Courses.CourseName</strong>
                                    @{
                                        string courseType = "";
                                        string badgeClass = "bg-info";
                                        switch (item.Courses.CourseType)
                                        {
                                            case 1: courseType = "专业必修"; badgeClass = "bg-danger"; break;
                                            case 2: courseType = "公共/思政必修"; badgeClass = "bg-danger"; break;
                                            case 3: courseType = "专业选修"; badgeClass = "bg-primary"; break;
                                            case 4: courseType = "公共选修"; badgeClass = "bg-primary"; break;
                                            case 5: courseType = "体育选修"; badgeClass = "bg-success"; break;
                                            default: courseType = "未知"; break;
                                        }
                                    }
                                    <br /><span class="badge @badgeClass" style="font-size: 11px;">@courseType</span>
                                </td>
                                <td>
                                    @if (item.Courses.Teachers != null)
                                    {
                                        @item.Courses.Teachers.TeacherName
                                    }
                                    else
                                    {
                                        <span class="text-muted">待分配</span>
                                    }
                                </td>
                                <td>@item.Courses.Credits</td>
                                <td>
                                    @{
                                        var schedules = courseSchedules.Where(cs => cs.CourseID == item.CourseID).ToList();
                                        string[] dayNames = { "", "周一", "周二", "周三", "周四", "周五", "周六", "周日" };
                                    }
                                    @if (schedules.Any())
                                    {
                                        foreach (var schedule in schedules)
                                        {
                                            var dayName = schedule.DayOfWeek >= 1 && schedule.DayOfWeek <= 7 ? dayNames[schedule.DayOfWeek] : "未知";
                                            <div style="margin-bottom: 4px;">
                                                <span class="badge bg-secondary">第@(schedule.StartWeek)-@(schedule.EndWeek)周</span>
                                                <span class="badge bg-secondary">@dayName 第@(schedule.StartPeriod)-@(schedule.EndPeriod)节</span>
                                                <span class="badge bg-success">@schedule.Classroom</span>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <small class="text-muted">时间地点待定</small>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (item.Courses.CourseType == 1 || item.Courses.CourseType == 2)
                                    {
                                        <button type="button" class="btn btn-secondary btn-sm" disabled title="必修课程不可退选">不可退选</button>
                                    }
                                    else
                                    {
                                        using (Html.BeginForm("WithdrawCourse", "Student", new { courseId = item.CourseID }, FormMethod.Post, new { @style = "display: inline;" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('确定要退选【@item.Courses.CourseName】吗？');">退 选</button>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="text-muted text-center" style="margin-top: 20px;">您当前课表为空。</p>
        }
    </div>

    <div class="tab-pane" id="sports-market">
        <div class="alert alert-success">
            <strong>📌 选课要求:</strong> 体育选修课每人每学期限选 1 门，您当前已选 @Model.SportsCoursesTaken 门。
        </div>
        @Html.Partial("_CourseListPartial", Model.SportsElectives)
    </div>

    <div class="tab-pane" id="other-market">
        <div class="alert alert-info">
            <strong>📌 选课要求:</strong> 大学三年期间需选够 4 门，您当前已选 @ViewBag.OtherCoursesTaken 门。
        </div>
        @Html.Partial("_CourseListPartial", Model.OtherElectives)
    </div>

</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // 自动淡出提示框
            setTimeout(function () {
                $(".alert-dismissible").fadeOut('slow');
            }, 3000);

            // 你喜欢的原生 JS 按钮切换逻辑
            $('.timetable-tabs .btn').on('click', function (e) {
                e.preventDefault();

                // 按钮样式切换 (Bootstrap 5 推荐用 btn-light 替代旧的 btn-default)
                $('.timetable-tabs .btn').removeClass('btn-primary active').addClass('btn-light');
                $(this).removeClass('btn-light').addClass('btn-primary active');

                // 内容区切换
                var targetPaneId = $(this).data('target');
                $('#main-tab-content > .tab-pane').removeClass('active');
                $(targetPaneId).addClass('active');
            });
        });
    </script>
}

<style>
    /* --- 解决闪屏并控制显示的 CSS --- */
    .tab-content > .tab-pane {
        display: none !important;
    }

    .tab-content > .active {
        display: block !important;
        animation: fadeIn 0.3s;
    }

    keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .timetable-tabs {
        margin-bottom: 5px;
        display: flex;
        gap: 10px; /* 让按钮之间有一点点缝隙，看起来更好看 */
    }

    .table td {
        vertical-align: middle !important;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
</style>